<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registrar domicilio</title>

  <!-- Leaflet CSS (sin integrity/crossorigin) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body { text-align:center; font-family: Arial, sans-serif; padding:10px; }
    #map { height: 420px; width: 92%; margin: 12px auto; border:1px solid #ccc; }
    input, button { width: 92%; padding:10px; margin:10px auto; font-size:1rem; }
    button { cursor:pointer; }
    #mensaje { margin-top:8px; }
  </style>
</head>
<body>
  <h2>Registrar domicilio (latitud/longitud)</h2>
  <input type="text" id="clave" placeholder="CLAVE DE TRABAJADOR" />
  <div id="map"></div>
  <button id="enviar">Enviar</button>
  <p id="mensaje"></p>

  <!-- Leaflet JS (sin integrity/crossorigin) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const msg = document.getElementById("mensaje");

      // Si Leaflet no cargó, avisa y detén.
      if (typeof L === "undefined") {
        msg.textContent = "Error: no se pudo cargar Leaflet. Revisa tu conexión o bloqueadores.";
        return;
      }

      const map = L.map("map").setView([19.4326, -99.1332], 9);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
      }).addTo(map);

      let marker = null;
      let position = null;

      map.on("click", (e) => {
        position = e.latlng;
        if (marker) marker.remove();
        marker = L.marker(position).addTo(map);
      });

      document.getElementById("enviar").addEventListener("click", async () => {
        const clave = document.getElementById("clave").value.trim();
        if (!clave || !position) {
          msg.textContent = "Error: falta la clave o seleccionar un punto en el mapa.";
          return;
        }
        msg.textContent = "Enviando...";

        try {
          const r = await fetch("/api/ubicacion", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ clave, lat: position.lat, lon: position.lng })
          });
          const data = await r.json();
          if (!r.ok) throw new Error(data?.message || "Error desconocido");
          msg.textContent = "✅ Ubicación guardada correctamente.";
        } catch (e) {
          console.error(e);
          msg.textContent = "Error: " + (e.message || e);
        }
      });
    });
  </script>
</body>
</html>
